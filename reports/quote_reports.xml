<?xml version="1.0" encoding="utf-8"?>
<odoo>
<data>

<!-- ========================= -->
<!-- 1) BASE (factorisée)      -->
<!-- ========================= -->
<template id="modern_report_saleorder_base">
<t t-call="web.html_container">
<t t-foreach="docs" t-as="o">
<t t-call="web.external_layout">
<t t-set="o" t-value="o.with_context(lang=o.partner_id.lang)"/>
<t t-set="company" t-value="o.company_id"/>

<div class="page">

<!-- En-tête avec logo et code-barres -->
<div class="row mb-4">
<div class="col-3">
<img t-if="company.logo" t-att-src="image_data_uri(company.logo)" alt="Logo" style="max-height:80px;"/>
</div>
<div class="col-6 text-center">
<h2 style="color:#0AA2C0; margin:0;">
<span t-if="o.state in ['draft','sent']">QUOTATION</span>
<span t-else="">SALE ORDER</span>
</h2>
<h4 style="margin:0;">
<span t-if="o.state in ['draft','sent']">Quotation #:</span>
<span t-else="">Order #:</span>
<strong><span t-esc="o.name"/></strong>
</h4>
</div>
<div class="col-3 text-end">
<img t-att-src="'/report/barcode/Code128/%s?width=180&amp;height=40' % o.name" style="max-width:180px;height:40px;" alt="Barcode"/>
</div>
</div>

<!-- Informations client et dates -->
<div class="row mb-4">
<div class="col-6">
<strong style="color:#0AA2C0;">Customer:</strong><br/>
<span t-field="o.partner_id.name"/><br/>
<span t-if="o.partner_id.street" t-field="o.partner_id.street"/><br/>
<span t-if="o.partner_id.street2" t-field="o.partner_id.street2"/><br/>
<span t-if="o.partner_id.city" t-field="o.partner_id.city"/>
<span t-if="o.partner_id.state_id.name" t-field="o.partner_id.state_id.name"/>
<span t-if="o.partner_id.zip" t-field="o.partner_id.zip"/><br/>
<span t-if="o.partner_id.country_id.name" t-field="o.partner_id.country_id.name"/><br/>
<span t-if="o.partner_id.vat">VAT: <span t-field="o.partner_id.vat"/></span>
</div>
<div class="col-6">
<table class="table table-sm table-borderless">
<tr>
<td><strong>Quotation Date:</strong></td>
<td><span t-field="o.date_order" t-options='{"widget":"date"}'/></td>
</tr>
<tr t-if="o.validity_date">
<td><strong>Expiration:</strong></td>
<td><span t-field="o.validity_date" t-options='{"widget":"date"}'/></td>
</tr>
<tr t-if="o.client_order_ref">
<td><strong>Your Reference:</strong></td>
<td><span t-field="o.client_order_ref"/></td>
</tr>
<tr t-if="o.user_id">
<td><strong>Salesperson:</strong></td>
<td><span t-field="o.user_id.name"/></td>
</tr>
</table>
</div>
</div>

<!-- Tableau des produits -->
<table class="table table-sm">
<thead style="background-color:#0AA2C0; color:white;">
<tr>
<th>Product</th>
<th>Description</th>
<th class="text-end">Qty</th>
<th t-if="show_prices" class="text-end">Unit Price</th>
<th t-if="show_prices" class="text-end">Taxes</th>
<th t-if="show_prices" class="text-end">Amount</th>
</tr>
</thead>
<tbody>
<t t-foreach="o.order_line" t-as="line">
<tr t-if="line.product_uom_qty and not line.is_delivery">
<td>
<strong><span t-field="line.product_id.default_code"/></strong>
<div style="font-size:11px; margin-top:3px;">
<span t-field="line.product_id.name"/>
</div>
</td>
<td>
<div><span t-field="line.name"/></div>
<div t-if="line.product_id.product_template_attribute_value_ids" style="margin-top:5px;">
<small style="color:#666; font-style:italic;">
<i class="fa fa-tag" style="margin-right:3px;"></i>
<strong>Variant:</strong>
<span t-esc="', '.join(line.product_id.product_template_attribute_value_ids.mapped('name'))"/>
</small>
</div>
</td>
<td class="text-end">
<span t-field="line.product_uom_qty"/>
<span t-field="line.product_uom" groups="uom.group_uom"/>
</td>
<td t-if="show_prices" class="text-end">
<span t-field="line.price_unit"/>
</td>
<td t-if="show_prices" class="text-end">
<span t-esc="', '.join(map(lambda x: x.name, line.tax_id))"/>
</td>
<td t-if="show_prices" class="text-end">
<strong><span t-field="line.price_subtotal"/></strong>
</td>
</tr>
</t>
</tbody>
</table>

<!-- Totaux (si show_prices) -->
<div t-if="show_prices" class="row justify-content-end mt-4">
<div class="col-5">
<table class="table table-sm">
<tr>
<td><strong>Subtotal:</strong></td>
<td class="text-end"><span t-field="o.amount_untaxed"/></td>
</tr>
<tr>
<td><strong>Taxes:</strong></td>
<td class="text-end"><span t-field="o.amount_tax"/></td>
</tr>
<tr style="background-color:#0AA2C0; color:white;">
<td><strong>TOTAL:</strong></td>
<td class="text-end"><strong><span t-field="o.amount_total"/></strong></td>
</tr>
</table>
</div>
</div>

<!-- Notes et conditions -->
<div t-if="o.note" class="mt-4">
<strong style="color:#0AA2C0;">Notes:</strong>
<p t-field="o.note"/>
</div>

<div t-if="o.payment_term_id" class="mt-2">
<strong style="color:#0AA2C0;">Payment Terms:</strong>
<span t-field="o.payment_term_id.name"/>
</div>

</div>
</t>
</t>
</t>
</template>

<!-- ========================= -->
<!-- 2) VARIANTE : AVEC PRIX   -->
<!-- ========================= -->
<template id="modern_report_saleorder_with_prices">
<t t-set="show_prices" t-value="True"/>
<t t-call="portal_customer_quotes.modern_report_saleorder_base"/>
</template>

<!-- ========================= -->
<!-- 3) VARIANTE : SANS PRIX   -->
<!-- ========================= -->
<template id="modern_report_saleorder_without_prices">
<t t-set="show_prices" t-value="False"/>
<t t-call="portal_customer_quotes.modern_report_saleorder_base"/>
</template>

<!-- ========================= -->
<!-- 4) Actions de rapport     -->
<!-- ========================= -->
<record id="action_modern_report_saleorder_with_prices" model="ir.actions.report">
<field name="name">Quotation (with prices)</field>
<field name="model">sale.order</field>
<field name="report_type">qweb-pdf</field>
<field name="report_name">portal_customer_quotes.modern_report_saleorder_with_prices</field>
<field name="print_report_name">'Quotation_' + (object.name or 'SO')</field>
</record>

<record id="action_modern_report_saleorder_without_prices" model="ir.actions.report">
<field name="name">Quotation (no prices)</field>
<field name="model">sale.order</field>
<field name="report_type">qweb-pdf</field>
<field name="report_name">portal_customer_quotes.modern_report_saleorder_without_prices</field>
<field name="print_report_name">'Quotation_NoPrices_' + (object.name or 'SO')</field>
</record>

</data>
</odoo>